@using E_Commerce.ViewModels
@model E_Commerce.ViewModels.ProductDetailsViewModel

@{
    ViewData["Title"] = Model.Product.Name;
    Layout = "~/Views/Shared/_DatailsLayout.cshtml";
}
<br />
<div class="container py-5">
    <div class="row g-4">

        <!-- Product Image -->
        <div class="col-md-6">
            <div class="border rounded p-3 bg-light d-flex justify-content-center align-items-center"
                 style="height: 420px;">
                <img src="~/images/@Model.Product.DefualtImageUrl"
                     class="img-fluid"
                     style="max-height: 100%; object-fit: contain;"
                     alt="@Model.Product.Name" />
            </div>
        </div>


        <!-- Product Info -->
        <div class="col-md-6">
            <h2 class="fw-bold">@Model.Product.Name</h2>

            <p class="text-muted mb-2">
                Category:
                <span class="text-success">
                    @Model.Product.Category?.Name
                </span>
            </p>
            <h4 class="text-success mb-3" id="productPrice">
                @Model.Product.Variants.First().Price $
            </h4>

             @if (Model.Product.Variants != null && Model.Product.Variants.Any())
            {
                <div class="mb-3">
                    <h6 class="fw-bold">Size</h6>

                    <div class="d-flex gap-2 flex-wrap">
                        @foreach (var variant in Model.Product.Variants)
                        {
                            <button type="button"
                                    class="btn btn-outline-success variant-btn"
                                    data-price="@variant.Price"
                                    data-variant-id="@variant.Id">
                                @variant.Size
                            </button>
                        }
                    </div>
                </div>
            }
             
                
            


            <!-- Rating (Static for now) -->
            <div class="mb-3 text-warning">
                ★★★★☆
            </div>

            <p class="mb-4">
                @Model.Product.BriefDescription
            </p>

            @* Add To Cart Button *@
            <!-- Quantity & Add to Cart -->
            <div class="mb-3">
                <h6 class="fw-bold">Quantity</h6>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-outline-secondary" id="decreaseQty">-</button>
                    <input type="number" class="form-control text-center mx-2" id="quantity" name="quantity" value="1" min="1" style="width: 70px;" readonly>
                    <button type="button" class="btn btn-outline-secondary" id="increaseQty">+</button>
                </div>
            </div>

            <!-- Form for Add to Cart -->
            <form id="addToCartForm" method="post" asp-action="AddToCart" asp-controller="Cart">
                <input type="hidden" name="productId" value="@Model.Product.Id" />
                <input type="hidden" name="productVariantId" id="selectedVariantId" />
                <input type="hidden" name="quantity" id="formQuantity" value="1" />

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg" id="addToCartBtn">
                        <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                    </button>
                </div>
            </form>



    <!-- Tabs -->
    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#desc">
                        Description
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reviews">
                        Reviews
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Description -->
                <div class="tab-pane fade show active" id="desc">
                    <p>
                        @Model.Product.Description
                    </p>

                    <table class="table table-bordered w-50 mt-4">
                        <tr>
                            <th>Status</th>
                            <td>@(Model.Product.IsActive ? "Available" : "Unavailable")</td>
                        </tr>
                        <tr>
                            <th>Created At</th>
                            <td>@Model.Product.CreatedAt.ToShortDateString()</td>
                        </tr>
                    </table>
                </div>

                <!-- Reviews -->
                <div class="tab-pane fade" id="reviews">
                    
                    
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h4 class="mb-0">
                                        <i class="fas fa-star me-2 text-warning"></i>
                                        Product Reviews
                                    </h4>
                                </div>
                                <div class="card-body">
                                    @await Html.PartialAsync("_IndexRewiewPartial", Model.Reviews)
                                </div>
                            </div>
                        </div>
                    </div>

                    @await Html.PartialAsync("_AddReviewsPartial", new ReviewViewModel { 
                        ProductId = Model.Product.Id 
                    })
                    
                    
                 </div>
                

            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let selectedVariantId = null;
        const variantButtons = document.querySelectorAll('.variant-btn');
        const productPriceElement = document.getElementById('productPrice');
        const quantityInput = document.getElementById('quantity');
        const formQuantityInput = document.getElementById('formQuantity');
        const selectedVariantInput = document.getElementById('selectedVariantId');
        const decreaseBtn = document.getElementById('decreaseQty');
        const increaseBtn = document.getElementById('increaseQty');
        const addToCartForm = document.getElementById('addToCartForm');

        variantButtons.forEach(button => {
            button.addEventListener('click', function () {
=                variantButtons.forEach(btn => {
                    btn.classList.remove('active', 'btn-success');
                    btn.classList.add('btn-outline-success');
                });

                this.classList.remove('btn-outline-success');
                this.classList.add('active', 'btn-success');

                selectedVariantId = this.getAttribute('data-variant-id');
                const price = this.getAttribute('data-price');
                productPriceElement.textContent = price + ' $';

                selectedVariantInput.value = selectedVariantId;
            });
        });

        if (variantButtons.length > 0) {
            variantButtons[0].click();
        }

        decreaseBtn.addEventListener('click', function () {
            let currentQty = parseInt(quantityInput.value);
            if (currentQty > 1) {
                quantityInput.value = currentQty - 1;
                formQuantityInput.value = currentQty - 1;
            }
        });

        increaseBtn.addEventListener('click', function () {
            let currentQty = parseInt(quantityInput.value);
            quantityInput.value = currentQty + 1;
            formQuantityInput.value = currentQty + 1;
        });

        addToCartForm.addEventListener('submit', function (e) {
            if (!selectedVariantId) {
                e.preventDefault();
                alert('Please select a size.');
                return false;
            }
            return true;
        });
    });
</script>


@section Scripts {
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    let selectedVariantId = null;
                    const variantButtons = document.querySelectorAll('.variant-btn');
                    const productPriceElement = document.getElementById('productPrice');
                    const quantityInput = document.getElementById('quantity');
                    const decreaseBtn = document.getElementById('decreaseQty');
                    const increaseBtn = document.getElementById('increaseQty');
                    const addToCartBtn = document.getElementById('addToCartBtn');
                    const productId = @Model.Product.Id;
                    variantButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            variantButtons.forEach(btn => {
                                btn.classList.remove('active', 'btn-success');
                                btn.classList.add('btn-outline-success');
                            });

                            this.classList.remove('btn-outline-success');
                            this.classList.add('active', 'btn-success');

                            selectedVariantId = this.getAttribute('data-variant-id');
                            const price = this.getAttribute('data-price');
                            productPriceElement.textContent = price + ' $';
                        });
                    });

                    if (variantButtons.length > 0) {
                        variantButtons[0].click();
                    }

                    decreaseBtn.addEventListener('click', function () {
                        let currentQty = parseInt(quantityInput.value);
                        if (currentQty > 1) {
                            quantityInput.value = currentQty - 1;
                        }
                    });

                    increaseBtn.addEventListener('click', function () {
                        let currentQty = parseInt(quantityInput.value);
                        quantityInput.value = currentQty + 1;
                    });

                    addToCartBtn.addEventListener('click', async function () {
                        if (!selectedVariantId) {
                            alert('Please select a size.');
                            return;
                        }

                        const quantity = quantityInput.value;

                        const originalText = addToCartBtn.innerHTML;
                        addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
                        addToCartBtn.disabled = true;

                        try {
                            const response = await fetch('@Url.Action("AddToCart", "Cart")', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `productId=${productId}&productVariantId=${selectedVariantId}&quantity=${quantity}`
                            });

                            if (response.ok) {
                                showSuccessMessage('Product added to cart successfully!');
                            } else {
                                alert('Failed to add product to cart.');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('An error occurred while adding to cart.');
                        } finally {
                            addToCartBtn.innerHTML = originalText;
                            addToCartBtn.disabled = false;
                        }
                    });

                    // دالة لعرض رسالة النجاح
                    function showSuccessMessage(message) {
                        // إنشاء عنصر الرسالة
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                        messageDiv.style.top = '20px';
                        messageDiv.style.right = '20px';
                        messageDiv.style.zIndex = '9999';
                        messageDiv.style.minWidth = '300px';
                        messageDiv.innerHTML = `
                            <strong>Success!</strong> ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;

                        document.body.appendChild(messageDiv);

                        setTimeout(() => {
                            messageDiv.remove();
                        }, 3000);
                    }
                });
            </script>
}
